---
### conf/access-control.xml ###
- name: configure IdP with ipv6
  when: idp_ipv6 is defined
  vars:
    allowed_ranges:
      - "127.0.0.1/32"
      - "::1/128"
      - "{{ statuspage_ipv4 }}"
      - "{{ statuspage_ipv6 }}"
    allowed_ranges_status:
      - "{{ statuspage_dfn_ipv4 }}"
      - "{{ statuspage_dfn_ipv6 }}"
  block: &configure_access

    - name: configure access to IdP status
      community.general.xml:
        path: /opt/shibboleth-idp/conf/access-control.xml
        xpath: "{{ idp_access_policies_entry_xpath }}[@key='StatusAccessByIPAddress']"
        pretty_print: true
        namespaces: "{{ idp_access_namespaces }}"
        attribute: p:allowedRanges
        value: >-
           \#{ {
           {{
           (
           allowed_ranges |
           union(allowed_ranges_status) |
           select |
           map('regex_replace', "^(.*)", "'\1'") |
           join(",")
           )
           }}
           } }

    - name: configure access to status page for own and DFN IP ranges
      community.general.xml:
        path: /opt/shibboleth-idp/conf/access-control.xml
        xpath: "{{ idp_access_policies_entry_xpath }}[@key='AccessByIPAddress']"
        pretty_print: true
        namespaces: "{{ idp_access_namespaces }}"
        attribute: p:allowedRanges
        value: >-
           \#{ {
           {{
           (
           allowed_ranges |
           select |
           map('regex_replace', "^(.*)", "'\1'") |
           join(",")
           )
           }}
           } }

- name: configure IdP without ipv6
  when: idp_ipv6 is undefined
  vars:
    allowed_ranges:
      - "127.0.0.1/32"
      - "::1/128"
      - "{{ statuspage_ipv4 }}"
    allowed_ranges_status:
      - "{{ statuspage_dfn_ipv4 }}"
      - "{{ statuspage_dfn_ipv6 }}"
  block: *configure_access

- name: add reference to access policy in idp.properties
  lineinfile:
    path: /opt/shibboleth-idp/conf/idp.properties
    line: idp.status.accessPolicy=StatusAccessByIPAddress
